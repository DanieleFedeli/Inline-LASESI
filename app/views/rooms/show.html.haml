-provide(:title, @room.name)
%br
.container{:style => 'padding-left: 0px; padding-right: 0px;'}
  .page-header.media
    .media-body
      %h3.text-center.my-3
        =@room.name
      %p.text-center
        =@room.description
      
  .row
    .col-3.border-right
      %h4.text-center.my-auto.border-bottom
        Info
      -if @room.address.nil?
        .row#map.mx-auto{:style=>'width: 100%; height: 200px; margin: 5%;'}
        %label
          Address:
        =@room.address
      
      
      %label.mx-auto
        Da:
      %input.text-center#dateEvent_from{:type => 'text'}
      %br
      %label.mx-auto
        A:
      %input.text-center#dateEvent_to{:type => 'text'}
      
      %h4.text-center.my-3

        Room host:
        
      %table.table
        %tbody
        -@room.powers.each do |p|
          %tr
            %td.text-center=link_to p.user.username, user_path(p.user) 
      %button.btn.btn-secondary.btn-sm Remind me
    .col-6
      %h4.text-center.my-auto.border-bottom
        CODA
      %ul.list-group#userlist{:style => 'padding-top: 10px;'}
      
      .container.text-center#joindiv{:style => 'margin-top: 10px;'}
        -if can_delete?
          -if current_user != @room.user && !current_user.powers.exists?(room_id: @room.id)
            -if !current_user.nil? && current_user.reservations.find_by(room_id: @room.id).nil?
              =render 'join'
            -else
              =render 'unjoin'
          -else
            %button.btn.btn-primary{:disabled => ''} You can't join!
        -else
          %button.btn.btn-primary{:disabled => ''}
            Tempo scaduto!
            
    .col-3.border-left
      %h4.text-center.my-auto.border-bottom
        CHAT
      
        
:javascript
  $(document).ready(function(){
    updateList(getRoomJSON());
    var room_json = init(document.URL+'.json');
    if($('#map').length) {
      render_map_for_room_show(document.URL+'.json');
    }
    
    var dateFrom = $("#dateEvent_from").flatpickr({ 
      enableTime: true,
      altInput: true,
      altFromat: "F j, Y",
      dateFormat: 'Y-m-d H:i',
      minDate: room_json.time_from,
      maxDate: room_json.time_from,
      defaultDate: room_json.time_from,
    });
    
    var dateFrom = $("#dateEvent_to").flatpickr({ 
      enableTime: true,
      altInput: true,
      altFromat: "F j, Y",
      dateFormat: 'Y-m-d H:i',
      minDate: room_json.time_to,
      maxDate: room_json.time_to,
      defaultDate: room_json.time_to
    })
  
  getPartecipants();
  });
  function getRoomJSON(){
  var json = init(document.URL+'.json');
        var array = [];
        for(var i = 0; i < json.reservations.length; i++){
          array[i] = json.reservations[i].user.username;
        }


    return array
  }
  function getPartecipants(){ 
      //queries the server every 2 second to check for updates in the queue
      setTimeout(function(){
        
        updateList(getRoomJSON());
        getPartecipants();
      }, 3000);
    }
    
  function updateList(list){
    for (var i = 0; i < list.length; i++) {
    
      if($("#element"+i).length){
      //if elem exists update it
        if ($("#element"+i).html() != list[i]){
          console.log('Diverso!');
          $("#element"+i).children().html(list[i]);
        }
      }
      else{
      //else create it
        $("#userlist").append("<li>"+list[i]+"</li>");
        var item = $("#userlist").children().last()
        item.attr("id","element"+i);
      }
    }
    //remove old elements 
    if($("#userlist").children().length > list.length){
      for (var i = list.length; i < $("#userlist").children().length; i++) {
        $("#element"+i).remove();
      }
    }
  }
